# ==========================================
# PATH: Projects/Project_V_Digital_Earth/data_secure_vault.py
# DESCRIPTION: FBC Secure Data Exchange Protocol (SDEP)
# VERSION: v4.0-SDEP-SUPREME (Planetary-Grade)
# DATA MODE: REAL (CI-SAFE)
# ==========================================

import hashlib
import hmac
import os
import json
from datetime import datetime
from typing import Dict, Any


# ==========================================
# SDEP CONFIGURATION
# ==========================================
SDEP_PROTOCOL_VERSION = "SDEP-v4.0-SUPREME"
HASH_ALGORITHM = "sha256"

# Master exchange salt (REAL but CI-safe)
# Production: stored in HSM / Vault
MASTER_SALT = os.getenv(
    "FBC_SDEP_MASTER_SALT",
    "FBC_DIGITAL_EARTH_MASTER_KEY_SUPREME"
).encode("utf-8")


class SDEPComplianceError(Exception):
    """Raised when data exchange violates SDEP governance rules."""


class FBCDataVault:
    """
    Supreme Secure Data Exchange Protocol Vault (SDEP)

    Responsibilities:
    - Governance enforcement
    - Cryptographic anonymization
    - Audit-trace generation
    - Monetization-safe packaging
    - CI-safe & future-ready
    """

    VAULT_VERSION = "DATA-VAULT-v4.0-SUPREME"

    # ------------------------------------------
    # GOVERNED DATA CATEGORIES
    # ------------------------------------------
    GOVERNED_DATA_CATEGORIES = {
        "URBAN_TRAFFIC_FLOW": "HIGH_CLEARANCE",
        "URBAN_ENERGY_FLOW": "HIGH_CLEARANCE",
        "URBAN_RISK_PROFILE": "RESTRICTED_CLEARANCE",
        "URBAN_INFRASTRUCTURE_STATE": "RESTRICTED_CLEARANCE"
    }

    def __init__(self, city_id: str):
        self.city_id = city_id
        self.protocol_version = SDEP_PROTOCOL_VERSION

    # ------------------------------------------
    # CORE PACKAGING ENGINE
    # ------------------------------------------
    def encrypt_and_package(
        self,
        data_type: str,
        raw_payload: str
    ) -> Dict[str, Any]:

        timestamp = datetime.utcnow().isoformat()

        # --- Governance Validation ---
        if data_type not in self.GOVERNED_DATA_CATEGORIES:
            raise SDEPComplianceError(
                f"Data category '{data_type}' not approved under SDEP governance."
            )

        clearance = self.GOVERNED_DATA_CATEGORIES[data_type]

        # --- Input Normalization ---
        raw_payload = str(raw_payload)

        # --- Secure Anonymized Hash ---
        salted_payload = f"{raw_payload}|{timestamp}|{self.city_id}".encode("utf-8")

        secure_hash = hmac.new(
            MASTER_SALT,
            salted_payload,
            hashlib.sha256
        ).hexdigest().upper()

        # --- Exchange Token (Marketplace Reference) ---
        exchange_token = secure_hash[:40]

        # --- Payload Metrics ---
        payload_size_kb = round(len(raw_payload.encode("utf-8")) / 1024, 2)

        # --- Immutable Audit Trace ---
        audit_trace_id = hashlib.sha256(
            f"{secure_hash}|{timestamp}|{self.protocol_version}".encode("utf-8")
        ).hexdigest().upper()

        # --- Final Supreme Package ---
        package = {
            "sdep_protocol": self.protocol_version,
            "vault_version": self.VAULT_VERSION,
            "origin_city_node": self.city_id,
            "data_category": data_type,
            "security_clearance": clearance,
            "exchange_token": exchange_token,
            "audit_trace_id": audit_trace_id,
            "payload_size_kb": payload_size_kb,
            "is_monetizable": True,
            "timestamp_utc": timestamp
        }

        return package


# ==========================================
# STANDALONE SUPREME TEST (CI SAFE)
# ==========================================
if __name__ == "__main__":
    vault = FBCDataVault("Austin-Node-01")

    sample_payload = "CONSUMPTION_DATA_SAMPLE_102GB"

    packaged = vault.encrypt_and_package(
        "URBAN_ENERGY_FLOW",
        sample_payload
    )

    print("\n=== [FBC DIGITAL EARTH | SDEP SUPREME PACKAGE] ===\n")
    print(json.dumps(packaged, indent=4))
    print("\nSTATUS: PLANETARY DATA EXCHANGE READY üåç‚úÖ\n")
